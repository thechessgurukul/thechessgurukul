<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MNH0MG597R"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MNH0MG597R');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Game Review | The Chess Gurukul</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --navy: #14213d; --gold: #fca311; --off-white: #f8f9fa; --white: #ffffff; --shadow: 0 4px 20px rgba(0,0,0,0.08); }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--off-white); color: #212529; }
        nav { background: var(--navy); padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .nav-container { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: var(--gold); font-weight: 800; font-size: 1.4rem; text-decoration: none; }
        .main-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 1.4fr 1fr; gap: 25px; }
        .tool-card { background: var(--white); border-radius: 15px; padding: 20px; box-shadow: var(--shadow); border-top: 5px solid var(--gold); }
        
        /* HD Board & Eval Bar Layout */
        .analysis-area { display: flex; gap: 12px; justify-content: center; height: 450px; }
        #eval-bar-container { width: 30px; background: #403d39; border-radius: 4px; position: relative; overflow: hidden; border: 2px solid #2b2d42; }
        #eval-bar-fill { background: white; width: 100%; height: 50%; transition: height 0.7s cubic-bezier(0.4, 0, 0.2, 1); }
        #eval-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; bottom: 5px; color: var(--navy); z-index: 2; }
        #board { width: 450px; height: 450px; }

        .nav-btns { margin-top: 15px; display: flex; gap: 8px; justify-content: center; }
        .btn { border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9rem; }
        .btn-nav { background: #e9ecef; width: 50px; font-size: 1.2rem; }
        .btn-nav:hover { background: #dee2e6; }
        
        .action-btns { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        .btn-analyze { background: var(--navy); color: white; text-transform: uppercase; padding: 12px; }
        .btn-pdf { background: #d00000; color: white; display: none; }
        .btn-wa { background: #25D366; color: white; display: none; }
        .btn-reset { background: #f8f9fa; border: 1px solid #ccc; color: #666; }

        #ai-coach-output { background: #fffef0; border: 1px solid var(--gold); padding: 20px; border-radius: 12px; margin-top: 15px; min-height: 200px; }
        .loader { display: none; text-align: center; font-size: 30px; animation: pulse 1s infinite; color: var(--gold); }
        @keyframes pulse { 50% { opacity: 0.5; } }
        
        @media (max-width: 1000px) { .main-container { grid-template-columns: 1fr; } #board { width: 100%; max-width: 350px; } .analysis-area { height: 350px; } }
    </style>
</head>
<body>
    <nav><div class="nav-container"><a href="#" class="logo">THE CHESS GURUKUL</a></div></nav>
    
    <div class="main-container">
        <div class="tool-card">
            <div class="analysis-area">
                <div id="eval-bar-container">
                    <div id="eval-bar-fill"></div>
                    <div id="eval-text">0.0</div>
                </div>
                <div id="board"></div>
            </div>
            <div class="nav-btns">
                <button class="btn btn-nav" onclick="jumpTo(0)">Â«</button>
                <button class="btn btn-nav" onclick="step(-1)">â€¹</button>
                <button class="btn btn-nav" onclick="step(1)">â€º</button>
                <button class="btn btn-nav" onclick="jumpTo(1)">Â»</button>
            </div>
        </div>

        <div class="tool-card">
            <input type="text" id="studentName" placeholder="Enter Student Name" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box;">
            <textarea id="pgnInput" placeholder="Paste PGN here..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-family:inherit; box-sizing:border-box;"></textarea>
            
            <div class="action-btns">
                <button class="btn btn-analyze" id="analyzeBtn" onclick="startAnalysis()">âœ¨ Start AI Review</button>
                <button class="btn btn-pdf" id="pdfBtn" onclick="generatePDF()">ðŸ“„ Download PDF Report</button>
                <button class="btn btn-wa" id="waBtn" onclick="shareWhatsApp()">ðŸ“± Share on WhatsApp</button>
                <button class="btn btn-reset" onclick="location.reload()">Reset</button>
            </div>

            <div id="ai-coach-output">
                <div id="loader" class="loader">â™ž</div>
                <div id="report-content">
                    <div id="coach-text" style="color: #666;">Waiting for game input...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        var board = null, game = new Chess(), moveHistory = [], currentIndex = -1, moveEvals = [], lastFullAnalysis = "";

        window.onload = function() {
            board = Chessboard('board', {
                position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
        };

        function updateEvalBar(cp) {
            let val = Math.max(-1000, Math.min(1000, cp));
            let percent = 50 - (val / 20); 
            document.getElementById('eval-bar-fill').style.height = percent + "%";
            document.getElementById('eval-text').innerText = (cp / 100).toFixed(1);
        }

        function syncBoard() {
            let temp = new Chess();
            for (let i = 0; i <= currentIndex; i++) temp.move(moveHistory[i]);
            board.position(temp.fen());
            updateEvalBar(moveEvals[currentIndex] || 0);
        }

        function step(d) {
            currentIndex = Math.max(-1, Math.min(moveHistory.length - 1, currentIndex + d));
            syncBoard();
        }

        function jumpTo(end) {
            currentIndex = end === 0 ? -1 : moveHistory.length - 1;
            syncBoard();
        }

        async function startAnalysis() {
            const pgn = document.getElementById('pgnInput').value;
            const student = document.getElementById('studentName').value || "Student";
            if (!game.load_pgn(pgn)) return alert("Please provide a valid PGN.");

            moveHistory = game.history();
            currentIndex = moveHistory.length - 1;
            syncBoard();

            $("#analyzeBtn").prop('disabled', true);
            $("#loader").show();
            $("#coach-text").hide();

            const API_KEY = 'AIzaSyDZGTpA-vsZMpbvlAy2cBzlXTpt3FG9Zqo'; 
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Analyze this chess game for ${student}: ${pgn}. Provide a professional GM summary and end with 'Score: +200' (replace with actual eval in centipawns).` }] }] })
                });
                const data = await response.json();
                lastFullAnalysis = data.candidates[0].content.parts[0].text;

                let match = lastFullAnalysis.match(/Score:\s*([+-]?\d+)/);
                let score = match ? parseInt(match[1]) : 0;
                moveEvals[currentIndex] = score;
                updateEvalBar(score);

                $("#coach-text").html(`<strong>Report for ${student}</strong><br><div style="white-space:pre-wrap; margin-top:10px;">${lastFullAnalysis}</div>`).show();
                $("#pdfBtn, #waBtn").show();
            } catch (e) {
                $("#coach-text").html("<span style='color:red;'>Analysis failed. Please check your API key or connection.</span>").show();
            }
            $("#loader").hide();
            $("#analyzeBtn").prop('disabled', false);
        }

        function shareWhatsApp() {
            const student = document.getElementById('studentName').value || "Student";
            const text = encodeURIComponent(`*The Chess Gurukul - AI Report*\n*Student:* ${student}\n\n${lastFullAnalysis.substring(0, 700)}...`);
            window.open(`https://api.whatsapp.com/send?text=${text}`, '_blank');
        }

        function generatePDF() {
            const element = document.getElementById('report-content');
            const opt = { margin: 1, filename: 'Chess_Report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
